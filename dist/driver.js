import{Component,disposeDetector,Dynamic,State}from"./index.js";export class ListView{from;builder;parent;constructor(from,builder,parent=null){this.from=from;this.builder=builder;this.parent=parent}}export class Portal{selector;component;constructor(selector,component){this.selector=selector;this.component=component}}export class HTML{content;constructor(content){this.content=content}}export class RenderEngine{node;app;dynamicChangeDetectorStack=[];TrackDOMLife=new Set;constructor(node,app){this.node=node;this.app=app}DetectDOMChange(){const callback=()=>{let index=0;for(let context of this.TrackDOMLife){if(!context.element.isConnected){context.callback();this.TrackDOMLife.delete(context)}index++}window.requestAnimationFrame(callback)};callback()}HandleListView(listView,root){let IndexValueMap=[];let dfrag=document.createDocumentFragment();let iterator=0;for(let value of listView.from.get()){if(typeof value!="object"){console.error("ListView cannot work with primitives. Please use Objects, or use the wrap function");return}const _state=new State({value:value,index:iterator});_state.listen((()=>{listView.from.value[_state.get().index]=_state.get().value}));IndexValueMap.push(_state);dfrag.append(this.BuildDOMTree(listView.builder(_state)));iterator++}root.append(dfrag);const DetectChanges=event=>{if(root.isConnected==false){disposeDetector(DetectChanges);return}let OldArray=event.event=="update"?event.value:event.value.get(listView.from);let NewArray=listView.from.get();if(OldArray.length==0&&NewArray.length==0){IndexValueMap=[];return}if(OldArray.length==0&&NewArray.length!=0){let iterator=0;for(let value of NewArray){if(typeof value!="object"){console.error("ListView cannot work with primitives. Please use Objects, or use the wrap function");return}const _state=new State({value:value,index:iterator});_state.listen((()=>{listView.from.value[_state.get().index]=_state.get().value}));IndexValueMap.push(_state);dfrag.append(this.BuildDOMTree(listView.builder(_state)));iterator++}root.append(dfrag);return}if(OldArray.length!=0&&NewArray.length==0){IndexValueMap=[];root.innerHTML="";return}let OldArrayMap=new Map;let NewArrayMap=new Map;for(let index=0;index<Math.max(OldArray.length,NewArray.length);index++){if(typeof OldArray[index]!="object"&&OldArray[index]!=undefined){console.error("ListView cannot work with primitives. Please use Objects, or use primitive constructor");return}if(OldArray[index]!=undefined){OldArrayMap.set(OldArray[index],index)}if(typeof NewArray[index]!="object"&&NewArray[index]!=undefined){console.error("ListView cannot work with primitives. Please use Objects, or use primitive constructor");return}if(NewArray[index]!=undefined){NewArrayMap.set(NewArray[index],index)}}let padding=0;for(let value of OldArrayMap){if(NewArrayMap.has(value[0])===false){root.children[value[1]+padding].remove();IndexValueMap.splice(value[1]+padding,1);padding--}}for(let value of NewArrayMap){if(OldArrayMap.has(value[0])===false){if(root.children[value[1]]!=undefined){const _state=new State({value:value[0],index:value[1]});_state.listen((()=>{listView.from.value[_state.get().index]=_state.get().value}));IndexValueMap.splice(value[1],0,_state);root.children[value[1]].before(this.BuildDOMTree(listView.builder(_state)))}else{const _state=new State({value:value[0],index:value[1]});_state.listen((()=>{listView.from.value[_state.get().index]=_state.get().value}));IndexValueMap.push(_state);root.appendChild(this.BuildDOMTree(listView.builder(_state)))}}}padding=0;for(let item of IndexValueMap){if(item.get().index!=padding){item.update((prev=>({...prev,index:padding})))}padding++}};listView.from.listen(DetectChanges)}BuildDOMTree(component,initialNodeStack=[],root=0){const HandleComponentChildren=(el,ch)=>{for(let child of ch){el.append(this.BuildDOMTree(child))}};const HandleComponentProperties=(el,properties)=>{for(let key of Object.keys(properties)){if(properties[key]=="__ignore__"||properties[key]==undefined)continue;if(key=="children"||key=="child"||key=="__driver__"||key=="reference"||key=="ondestroy"||key=="from"||key=="builder"||key=="parent")continue;switch(key){case"style":if(properties.style instanceof Dynamic){let styleKeys=[];let prevCondition=properties.style.condition.get();function ListenStyleChange(){let newStyles=properties.style.callback();if(prevCondition!=properties.style.condition.get()){let prevMap=new Map(styleKeys.map((value=>[value,false])));styleKeys=Object.keys(newStyles);for(let style of styleKeys){prevMap.set(style,true)}prevMap.forEach(((value,styleName)=>{if(value==false){el.style[styleName]=""}else{el.style[styleName]=newStyles[styleName]}}));prevCondition=properties.style.condition.get()}else if(properties.style.condition.get()==null){let prevMap=new Map(styleKeys.map((value=>[value,false])));styleKeys=Object.keys(newStyles);for(let style of styleKeys){prevMap.set(style,true)}prevMap.forEach(((value,styleName)=>{if(value==false){el.style[styleName]=""}else{el.style[styleName]=newStyles[styleName]}}))}}Dynamic.assign(ListenStyleChange)}else{for(let style of Object.keys(properties.style)){if(properties.style[style]==""||properties.style[style]==undefined)continue;if(typeof properties.style[style]=="string"){el.style[style]=properties.style[style]}else{let prevCondition=properties.style[style].condition.get();function CommonStateCallback(){const _style=properties.style[style].callback();if(prevCondition!=properties.style[style].condition.get()){el.style[style]=_style;prevCondition=properties.style[style].condition.get()}else if(properties.style[style].condition.get()==null){el.style[style]=_style}}properties.style[style].assign(CommonStateCallback)}}}break;default:if(key.at(0)=="o"&&key.at(1)=="n"){el[key]=properties[key]}else{if(typeof properties[key]=="string"){el.setAttribute(key,properties[key]);el[key]=properties[key]}else{let prevCondition=properties[key].condition.get();function CommonStateCallback(){let callback=properties[key].callback();if(prevCondition!=properties[key].condition.get()){if(callback==""){if(el.hasAttribute(key)){el.removeAttribute(key);delete el[key]}}else{el.setAttribute(key,callback);el[key]=callback}prevCondition=properties[key].condition.get()}else if(properties[key].condition.get()==null){if(callback==""){if(el.hasAttribute(key)){el.removeAttribute(key);delete el[key]}}else{el.setAttribute(key,callback);el[key]=callback}}}Dynamic.assign(CommonStateCallback)}}}}};if(typeof component=="function"){const callback=component();if(callback instanceof Component||callback.constructor==String){return this.BuildDOMTree(callback)}else{console.error("Error: Dynamic Callback can only return another Component or a RAW String")}}else if(component instanceof Dynamic){let prevConditon=component.condition.get();let NodeStack=initialNodeStack;const DetectChanges=()=>{const callback=component.callback();if(NodeStack.length==0){const temp=this.BuildDOMTree(callback,NodeStack,root+1);NodeStack.push(temp);return}if(component.condition.get()!=prevConditon){for(;this.dynamicChangeDetectorStack.length!=root;){disposeDetector(this.dynamicChangeDetectorStack.pop())}const temp=this.BuildDOMTree(callback,NodeStack,root+1);NodeStack.pop().replaceWith(temp);NodeStack.push(temp);prevConditon=component.condition.get()}else if(component.condition.get()==null){for(;this.dynamicChangeDetectorStack.length!=root;){disposeDetector(this.dynamicChangeDetectorStack.pop())}const temp=this.BuildDOMTree(callback,NodeStack,root+1);NodeStack.pop().replaceWith(temp);NodeStack.push(temp)}};if(root!=0){this.dynamicChangeDetectorStack.push(DetectChanges)}Dynamic.assign(DetectChanges);return NodeStack[0]}else if(component.constructor==String){return document.createTextNode(component.valueOf())}else if(component.name!=undefined){const HandleComponentMetaData=(hasChild=true)=>{if(component.properties!=undefined){HandleComponentProperties(element,component.properties);if(hasChild!=false){if(component.properties.child!=undefined){HandleComponentChildren(element,[component.properties.child])}else if(component.properties.children!=undefined){HandleComponentChildren(element,component.properties.children)}}if(component.properties!=undefined){if(component.properties.reference!=undefined){component.properties.reference.set(element)}if(component.properties.ondestroy!=undefined){this.TrackDOMLife.add({element:element,callback:component.properties.ondestroy})}}}};const lookupTable={portal:(engine,component)=>{let el=document.querySelector(component.properties.__driver__.selector);el.replaceWith(engine.BuildDOMTree(component.properties.__driver__.component));return document.createComment("PE")},html:(engine,component)=>{const HTMLData=component.properties.__driver__;let element=document.createElement("div");element.innerHTML=HTMLData.content.toString();if(element.children.length>1){return element}else{return element.children[0]}},empty:()=>document.createComment("EM"),listview:(engine,component)=>{let element;if(component.properties.__driver__.parent!=null){element=engine.BuildDOMTree(component.properties.__driver__.parent)}else{element=document.createElement("div")}engine.HandleListView(component.properties.__driver__,element);return element}};const build=component=>{if(component.name!="portal"&&component.name!="html"&&component.name!="empty"&&component.name!="listview"){const el=document.createElement(component.name);return el}else{return lookupTable[component.name](this,component)}};let element=build(component);HandleComponentMetaData(component.hasChild);return element}else{throw"[Error] Unable to make component: Component is neither a string, nor a dynamic or a pure component."}}Render(){this.DetectDOMChange();this.node.replaceWith(this.BuildDOMTree(this.app()))}}export function RenderWebPlatform(args){const Engine=new RenderEngine(document.querySelector(args.selector),args.app);Engine.Render()}